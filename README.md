/* Creación de usuario si está trabajando con BD Oracle Cloud */
CREATE USER MDY3131_PRUEBA2 IDENTIFIED BY "MDY3131.prueba_2"
DEFAULT TABLESPACE "DATA"
TEMPORARY TABLESPACE "TEMP";
ALTER USER MDY3131_PRUEBA2 QUOTA UNLIMITED ON DATA;
GRANT CREATE SESSION TO MDY3131_PRUEBA2;
GRANT "RESOURCE" TO MDY3131_PRUEBA2;
ALTER USER MDY3131_PRUEBA2 DEFAULT ROLE "RESOURCE";


SELECT * FROM ASESORIA;
SELECT * FROM COMUNA;
SELECT * FROM PROFESIONAL;
SELECT * FROM PROFESION;
SELECT * FROM DETALLE_ASIGNACION_MES;
SELECT * FROM ERRORES_PROCESO;
SELECT * FROM RESUMEN_MES_PROFESION;


DECLARE
    -- VARIABLES DE CONTROL
    V_ANIO_TEST NUMBER := 2021; -- Año de prueba
    V_MES_TEST NUMBER := 6;     -- Mes de prueba (junio)

    -- Calcular la fecha de inicio y fin del mes de prueba
    V_FECHA_INICIO DATE := TRUNC(TO_DATE(V_ANIO_TEST || '-' || V_MES_TEST || '-01', 'YYYY-MM-DD'), 'MM');
    V_FECHA_FIN DATE := LAST_DAY(V_FECHA_INICIO);
   
    V_LIMITE_ASIGNACION CONSTANT NUMBER := 250000;
    V_ERROR_MSG VARCHAR2(300);
    V_NUM_ASESORIAS NUMBER;
    V_PORCENTAJE_TIPOCONT NUMBER;
    V_PORCENTAJE_PROFESION NUMBER;

    -- Definición de VARRAY para porcentajes de asignación de movilización extra
    TYPE PORCENTAJE_ARRAY IS VARRAY(5) OF NUMBER;
    V_PORCENTAJE PORCENTAJE_ARRAY := PORCENTAJE_ARRAY(2, 4, 5, 7, 9);

    -- CURSOR PARA OBTENER FECHAS DE INICIO DE ASESORÍAS (SIN PARÁMETRO)
    CURSOR C_FECHAS_ASESORIAS IS 
        SELECT DISTINCT INICIO_ASESORIA
        FROM ASESORIA
        WHERE INICIO_ASESORIA BETWEEN V_FECHA_INICIO AND V_FECHA_FIN
        ORDER BY INICIO_ASESORIA;

    -- CURSOR CON PARÁMETRO PARA DETALLE DE ASESORÍAS
    CURSOR C_DETALLE_ASESORIA(P_FECHA DATE) IS
    SELECT P.NUMRUN_PROF, P.NOMBRE, P.APPATERNO, P.APMATERNO, 
           PR.NOMBRE_PROFESION, P.COD_TPCONTRATO, A.INICIO_ASESORIA, A.HONORARIO, 
           C.NOM_COMUNA AS COMUNA
    FROM ASESORIA A
    JOIN PROFESIONAL P ON A.NUMRUN_PROF = P.NUMRUN_PROF
    JOIN EMPRESA E ON A.COD_EMPRESA = E.COD_EMPRESA  
    JOIN COMUNA C ON P.COD_COMUNA = C.COD_COMUNA
    JOIN PROFESION PR ON P.COD_PROFESION = PR.COD_PROFESION
    WHERE A.INICIO_ASESORIA = P_FECHA;


    -- VARIABLE PARA ALMACENAR DATOS DETALLADOS
    R_DETALLE DETALLE_ASIGNACION_MES%ROWTYPE;
    V_ASIGNACION NUMBER;
    V_TOTAL_HONORARIOS NUMBER;
    
    -- EXCEPCIONES PERSONALIZADAS
    EXCEPTION_LIMITE EXCEPTION;

BEGIN
    -- TRUNCADO DE TABLAS Y REINICIO DE SECUENCIA
    EXECUTE IMMEDIATE 'TRUNCATE TABLE DETALLE_ASIGNACION_MES';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE RESUMEN_MES_PROFESION';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE ERRORES_PROCESO';
    EXECUTE IMMEDIATE 'ALTER SEQUENCE SQ_ERROR RESTART START WITH 1';

    -- PROCESAR FECHAS DE ASESORÍAS
    FOR R_FECHA IN C_FECHAS_ASESORIAS LOOP
        FOR R_ASESORIA IN C_DETALLE_ASESORIA(R_FECHA.INICIO_ASESORIA) LOOP
            BEGIN
                -- Cálculo del total de honorarios
                SELECT SUM(HONORARIO) 
                INTO V_TOTAL_HONORARIOS
                FROM ASESORIA
                WHERE NUMRUN_PROF = R_ASESORIA.NUMRUN_PROF
                AND INICIO_ASESORIA BETWEEN V_FECHA_INICIO AND V_FECHA_FIN;
                  
                -- Obtener el número de asesorías realizadas
                SELECT COUNT(*) 
                INTO V_NUM_ASESORIAS
                FROM ASESORIA
                WHERE NUMRUN_PROF = R_ASESORIA.NUMRUN_PROF
                AND INICIO_ASESORIA BETWEEN V_FECHA_INICIO AND V_FECHA_FIN;
                
                -- Obtener el porcentaje de asignación basado en el tipo de contrato del profesional
                SELECT INCENTIVO
                INTO V_PORCENTAJE_TIPOCONT
                FROM TIPO_CONTRATO
                WHERE COD_TPCONTRATO = R_ASESORIA.COD_TPCONTRATO;
                
                -- Obtener el porcentaje de asignación según la profesión del profesional
                SELECT ASIGNACION
                INTO V_PORCENTAJE_PROFESION
                FROM PORCENTAJE_PROFESION
                WHERE COD_PROFESION = (SELECT COD_PROFESION FROM PROFESIONAL WHERE NUMRUN_PROF = R_ASESORIA.NUMRUN_PROF);
                
                -- Cálculo de asignaciones según la comuna
                IF R_ASESORIA.COMUNA = 'Santiago' THEN
                    V_ASIGNACION := ROUND(V_TOTAL_HONORARIOS * V_PORCENTAJE(1) / 100);
                ELSIF R_ASESORIA.COMUNA = ' u oa' THEN
                    V_ASIGNACION := ROUND(V_TOTAL_HONORARIOS * V_PORCENTAJE(2) / 100);
                ELSIF R_ASESORIA.COMUNA = 'La Reina' THEN
                    V_ASIGNACION := ROUND(V_TOTAL_HONORARIOS * V_PORCENTAJE(3) / 100);
                ELSIF R_ASESORIA.COMUNA = 'La Florida' THEN
                    V_ASIGNACION := ROUND(V_TOTAL_HONORARIOS * V_PORCENTAJE(4) / 100);
                ELSIF R_ASESORIA.COMUNA = 'Macul' THEN
                    V_ASIGNACION := ROUND(V_TOTAL_HONORARIOS * V_PORCENTAJE(5) / 100);
                ELSE
                    V_ASIGNACION := 0; 
                END IF;

                -- Aplicar el límite de asignación
                IF V_ASIGNACION > V_LIMITE_ASIGNACION THEN
                    RAISE EXCEPTION_LIMITE;
                END IF;

                -- Asignar valores a la variable de detalle antes de insertar
                R_DETALLE.MES_PROCESO := V_MES_TEST;
                R_DETALLE.ANNO_PROCESO := V_ANIO_TEST;
                R_DETALLE.RUN_PROFESIONAL := TO_CHAR(R_ASESORIA.NUMRUN_PROF);
                R_DETALLE.NOMBRE_PROFESIONAL := R_ASESORIA.NOMBRE || ' ' || R_ASESORIA.APPATERNO || ' ' || R_ASESORIA.APMATERNO;
                R_DETALLE.PROFESION := TO_CHAR(R_ASESORIA.NOMBRE_PROFESION);
                R_DETALLE.NRO_ASESORIAS := V_NUM_ASESORIAS;
                R_DETALLE.MONTO_HONORARIOS := V_TOTAL_HONORARIOS;
                R_DETALLE.MONTO_MOVIL_EXTRA := V_ASIGNACION;
                R_DETALLE.MONTO_ASIG_TIPOCONT := ROUND(V_TOTAL_HONORARIOS * (V_PORCENTAJE_TIPOCONT / 100));
                R_DETALLE.MONTO_ASIG_PROFESION := ROUND(V_TOTAL_HONORARIOS * (V_PORCENTAJE_PROFESION / 100));
                R_DETALLE.MONTO_TOTAL_ASIGNACIONES := V_ASIGNACION + R_DETALLE.MONTO_ASIG_TIPOCONT + R_DETALLE.MONTO_ASIG_PROFESION;

                -- Insertar datos en la tabla
                INSERT INTO DETALLE_ASIGNACION_MES VALUES R_DETALLE;

                EXCEPTION
                WHEN EXCEPTION_LIMITE THEN
                V_ERROR_MSG:= SQLERRM;
                    INSERT INTO ERRORES_PROCESO (ERROR_ID, MENSAJE_ERROR_ORACLE, MENSAJE_ERROR_USR)
                    VALUES (SQ_ERROR.NEXTVAL,V_ERROR_MSG, 'Error, profesional supera el monto límite de asignaciones. Run Nro. ' || 
                        TO_CHAR(R_ASESORIA.NUMRUN_PROF) ||' - Se reemplazó el monto total de las asignaciones calculadas de ' || 
                        TO_CHAR(V_ASIGNACION) || 
                        ' por el monto límite de ' || 
                        TO_CHAR(V_LIMITE_ASIGNACION));

                WHEN DUP_VAL_ON_INDEX THEN
                V_ERROR_MSG:= SQLERRM;
                    INSERT INTO ERRORES_PROCESO (ERROR_ID, MENSAJE_ERROR_ORACLE, MENSAJE_ERROR_USR)
                    VALUES (SQ_ERROR.NEXTVAL,V_ERROR_MSG, 'Error de duplicidad en la inserción de datos para el run Nro. ' || 
                        TO_CHAR(R_ASESORIA.NUMRUN_PROF));
                        
                WHEN NO_DATA_FOUND THEN
                V_ERROR_MSG:= SQLERRM;
                INSERT INTO ERRORES_PROCESO (ERROR_ID, MENSAJE_ERROR_ORACLE, MENSAJE_ERROR_USR)
                VALUES (SQ_ERROR.NEXTVAL,V_ERROR_MSG, 'No se ha encontrado ningún dato para el run Nro. ' || 
                        TO_CHAR(R_ASESORIA.NUMRUN_PROF));

                WHEN OTHERS THEN
                V_ERROR_MSG:= SQLERRM;
                    INSERT INTO ERRORES_PROCESO (ERROR_ID, MENSAJE_ERROR_ORACLE, MENSAJE_ERROR_USR)
                    VALUES (SQ_ERROR.NEXTVAL, V_ERROR_MSG, 'Error general en el proceso para el run Nro. ' || 
                        TO_CHAR(R_ASESORIA.NUMRUN_PROF));

                END;
       
        END LOOP;
    END LOOP;

    INSERT INTO RESUMEN_MES_PROFESION (ANNO_MES_PROCESO, PROFESION, TOTAL_ASESORIAS, MONTO_TOTAL_HONORARIOS, 
                                      MONTO_TOTAL_MOVIL_EXTRA, MONTO_TOTAL_ASIG_TIPOCONT, 
                                      MONTO_TOTAL_ASIG_PROF, MONTO_TOTAL_ASIGNACIONES)
    SELECT 
        V_ANIO_TEST * 100 + V_MES_TEST AS ANNO_MES_PROCESO,
        PROFESION,
        SUM(NRO_ASESORIAS) AS TOTAL_ASESORIAS, -- Corrección aquí para sumar correctamente
        SUM(MONTO_HONORARIOS) AS MONTO_TOTAL_HONORARIOS,
        SUM(MONTO_MOVIL_EXTRA) AS MONTO_TOTAL_MOVIL_EXTRA,
        SUM(MONTO_ASIG_TIPOCONT) AS MONTO_TOTAL_ASIG_TIPOCONT,
        SUM(MONTO_ASIG_PROFESION) AS MONTO_TOTAL_ASIG_PROF,
        SUM(MONTO_TOTAL_ASIGNACIONES) AS MONTO_TOTAL_ASIGNACIONES
    FROM DETALLE_ASIGNACION_MES
    GROUP BY PROFESION;

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('PROCESO COMPLETADO EXITOSAMENTE');
    
    EXCEPTION
    WHEN EXCEPTION_LIMITE THEN
        DBMS_OUTPUT.PUT_LINE('ERROR: Límite de asignación excedido.');
    WHEN DUP_VAL_ON_INDEX THEN
        DBMS_OUTPUT.PUT_LINE('ERROR: Valores duplicados detectados.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR GENERAL: ' || V_ERROR_MSG);

END;
